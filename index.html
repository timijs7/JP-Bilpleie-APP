<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JP-Bilpleie</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="JP-Bilpleie" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  
  <!-- PDF: html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="storage-manager.js"></script>

  <style>
     body { font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif; margin:0; padding:16px; background:#f7f7fb; display: flex; justify-content: center;}
    .card { width: 50%; max-width: 180px; margin: 0 auto; padding: 16px; border-radius: 16px; background:#fff; box-shadow: 0 6px 24px rgba(0,0,0,0.08); }
    html, body {margin: 0; padding: 0; max-width: 100%;overflow-x: hidden;font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;background: #f7f7fb;}
    .container {display: flex; justify-content: center; padding: 16px; box-sizing: border-box;}
    .logo-top { text-align:center; margin-bottom:12px; }
    .logo-img { width:64px; height:64px; border-radius:12px; object-fit:contain; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    h2 { font-size: 20px; font-weight:700; color:#000; margin:20px 0 10px; border-bottom:2px solid #0a84ff; padding-bottom:4px; }
    label { display:block; font-weight:700; margin-top:12px; color:#000; }
    input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; font-size:16px; box-sizing:border-box; background:#fff; }
    textarea { min-height:80px; }
    button { margin-top:16px; padding:12px 16px; border:0; border-radius:10px; font-size:16px; cursor:pointer; }
    .primary { background:#15803d; color:#fff; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > div { flex:1; min-width:240px; }
    .small { font-size:12px; color:#666; }
    .msg { margin-top:12px; }
    .hidden { display:none !important; }
    .thumbs{display:grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap:10px; margin-top:8px;}
    .thumb{position:relative; width:100%; aspect-ratio:1/1; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb; background:#f8fafc;}
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; cursor:pointer; }
    .thumb .thumb-del{position:absolute; top:1px; right:4px; width:28px; height:28px; border:0; border-radius:50%; background:rgba(17,24,39,.9); color:#fff; display:flex; align-items:center;justify-content:center;font-size:12px; line-height:1; padding:0; cursor:pointer;}
    .thumb .thumb-del:hover{ background:#ef4444; }

    .work-table{width:100%;border-collapse:collapse;font-size:13px}
    .work-table th,.work-table td{border:1px solid #d1d5db;padding:8px 10px;vertical-align:top}
    .work-table th{background:#f3f4f6;text-align:left}
    .badge-yes{background:#dcfce7;color:#166534;padding:2px 8px;border-radius:12px;font-weight:700;display:inline-flex;gap:6px}
    .badge-no{background:#eef2f7;color:#6b7280;padding:2px 8px;border-radius:12px}

    /* Defektu shƒìma */
    .defect-wrap2 { border:1px dashed #bbb; border-radius:12px; padding:10px; background:#fff; }
    .defect-toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .defect-canvas {width: 60%; max-width: 350px; aspect-ratio: 2 / 3; background: #ffffff; border-radius: 12px; position: relative;margin: 0 auto; overflow: hidden;}
    .defect-canvas img.plan-img {width: 100%;height: 100%;object-fit: contain;display: block;user-select: none;-webkit-user-drag: none;pointer-events: none;}
    @media (max-width: 350px){ .defect-canvas { width: 100%; } }

    .pin { position:absolute; width:18px; height:18px; border-radius:50%; transform:translate(-50%,-50%); border:2px solid #fff; box-shadow:0 0 0 2px rgba(0,0,0,.15); cursor:grab; }
    .pin:active { cursor:grabbing; }
    .pin::after { content:attr(data-label); position:absolute; top:-22px; left:50%; transform:translateX(-50%); background:#111; color:#fff; font-size:10px; padding:2px 4px; border-radius:4px; white-space:nowrap; }
    .pin[data-type="scratch"]{ background:#ef4444; }

    /* PDF */
    .print-wrap { width: 794px; color:#111; }
    .pw-header { display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #0a84ff; padding-bottom:8px; margin-bottom:12px; }
    .pw-title { font-size:22px; font-weight:800; }
    .pw-doc { text-align:right; font-size:16px; line-height:1.4; }
    .kv { width:100%; border-collapse: collapse; }
    .kv th, .kv td { border:1px solid #d1d5db; padding:8px 10px; font-size:13px; vertical-align:top; }
    .kv th { background:#f3f4f6; text-align:left; width:32%; }
    .sec-title { font-size:14px; font-weight:800; margin:14px 0 6px; text-transform:uppercase; letter-spacing:.4px; color:#0f172a; }
    .text-box { min-height:44px; padding:8px; border:1px solid #d1d5db; border-radius:8px; background:#fff; font-size:13px; white-space:pre-wrap; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; }
    .chip { border:1px solid #c7cbd1; border-radius:999px; padding:4px 10px; font-size:12px; background:#f8fafc; }
    .photos-block { margin-top:8px; }
    .photo-item { margin-bottom:10px; page-break-inside: avoid; }
    .photo-item img { width:70%; border:1px solid #e5e7eb; border-radius:8px; display:block; }
    .photo-cap { font-size:12px; color:#475569; margin-top:4px; }

    .print-wrap, .print-wrap *{-webkit-text-size-adjust: none !important; /* iOS: neliec automƒÅtiski palielinƒÅt */text-size-adjust: none !important;}

    .print-wrap{ font-size: 13px; line-height: 1.35; }
    .pw-title{ font-size: 20px; }
    .kv th, .kv td, .text-box{ font-size: 12.5px; }
    .sec-title{ font-size: 13px; }

    .success-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
    .success-backdrop.show{display:flex}
    .success-pop{background:#fff;min-width:320px;max-width:92vw;border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.35);padding:22px 24px;text-align:center;opacity:0;transform:scale(.96);transition:opacity .18s ease,transform .18s ease}
    .success-pop.show{opacity:1;transform:scale(1)}
    .success-pop .icon{width:64px;height:64px;border-radius:50%;margin:6px auto 10px;display:grid;place-items:center;background:#dcfce7;color:#166534;font-size:30px}
    .success-pop h3{margin:4px 0 0;font-size:24px}
    .success-pop p{margin:6px 0 0;font-size:14px;color:#334155}
    .success-pop .btn{margin-top:12px;padding:10px 14px;border:0;border-radius:10px;background:#0a84ff;color:#fff;cursor:pointer}
    
    .works-list{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0;}
    @media (min-width:640px){ .works-list{ grid-template-columns:1fr 1fr; } }
    
    .work-item{ display:block; }
    .work-item input{ position:absolute; opacity:0; pointer-events:none; }
    .work-item .box{display:flex; align-items:center; gap:12px;padding:12px 14px; min-height:52px;border:1.5px solid #d0d7de; border-radius:12px;background:#fff;-webkit-tap-highlight-color: transparent;}
    .work-item .check{width:22px; height:22px; flex:0 0 22px;border:2px solid #94a3b8; border-radius:6px;background:#fff;}
    .work-item input:checked + .box{ border-color:#2563eb; background:#eff6ff; }
    .work-item input:checked + .box .check{background:#2563eb; border-color:#2563eb;box-shadow: inset 0 0 0 3px #fff;}
    .work-item .txt{ font-size:16px; line-height:1.25; color:#0f172a; }
    .work-item .txt b{ font-weight:700; }
  </style>
</head>
<body>
  <div class="card" id="formCard">
    <div class="logo-top">
      <img src="icons/icon-192.png" alt="Logo" class="logo-img">
    </div>

    <form id="form">
      <h2>Kunde</h2>
      <div class="row">
        <div>
          <label>Kundetype</label>
          <select id="companyType">
            <option value="business">Juridisk person (bedrift)</option>
            <option value="private">Privat (uten bedrift)</option>
          </select>
        </div>
        <div id="businessBlock">
          <label>Bedrift</label>
          <select id="companySelect">
            <option value="" selected disabled>‚Äî Velg bedrift ‚Äî</option>
            <option value="ferda">Ferda</option>
            <option value="motoforum">Motoforum</option>
            <option value="other">Annen‚Ä¶</option>
          </select>
          <div id="otherCompanyBlock" class="hidden" style="margin-top:8px">
            <input id="otherCompany" placeholder="Annet bedriftsnavn">
          </div>
        </div>
      </div>

      <h2>Kj√∏ret√∏y</h2>
      <div class="row">
        <div>
          <label>Ny eller brukt bil</label>
          <select id="carCondition" required>
            <option value="new">Ny</option>
            <option value="used">Brukt</option>
          </select>
        </div>
        <div>
          <label>Dato</label>
          <input id="date" type="date" required />
        </div>
      </div>

      <div class="row">
        <div><label>Merke</label><input id="brand" required /></div>
        <div><label>Modell</label><input id="model" /></div>
        <div><label>VIN / Reg.nr.</label><input id="vin" required /></div>
        <div><label>Kilometerstand (km)</label><input id="mileage" type="number" inputmode="numeric" min="0" step="1" /></div>
      </div>

      <label>Bilder av bilen</label>
      <input id="photos" type="file" accept="image/*" multiple capture="environment" required />
      <div class="thumbs" id="thumbs"></div>

      <h2>Arbeid</h2>
<div class="works-list" role="group" aria-labelledby="arbeid-title">
  <label class="work-item">
    <input type="checkbox" class="work" value="innvendig_vask">
    <div class="box"><span class="check" aria-hidden="true"></span><span class="txt">üßΩ <b>Innvendig vask</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="utvendig_vask_voks">
    <div class="box"><span class="check"></span><span class="txt">üöø‚ú® <b>Utvendig vask + voks</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="innvendig_utvendig_vask_voks">
    <div class="box"><span class="check"></span><span class="txt">üßΩüöø‚ú® <b>Innvendig/utvendig vask + voks</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="polering1_voks">
    <div class="box"><span class="check"></span><span class="txt">1Ô∏è‚É£üåÄ <b>1-stegs polering + voks</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="polering2_voks">
    <div class="box"><span class="check"></span><span class="txt">2Ô∏è‚É£üåÄ <b>2-stegs polering + voks</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="keramisk_coating">
    <div class="box"><span class="check"></span><span class="txt">üõ° <b>Keramisk coating</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="fullshine_pakke">
    <div class="box"><span class="check"></span><span class="txt">‚ú® <b>Fullshine pakke</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="express_utvendig_vask">
    <div class="box"><span class="check"></span><span class="txt">‚ö°üöø <b>Express utvendig vask</b></span></div>
  </label>

  <label class="work-item">
    <input type="checkbox" class="work" value="express_innvendig_vask">
    <div class="box"><span class="check"></span><span class="txt">‚ö°üßΩ <b>Express innvendig vask</b></span></div>
  </label>
</div>

<label>Andre arbeider / merknader</label>
<textarea id="workNotes" placeholder="Tilleggsbeskrivelse av utf√∏rt arbeid"></textarea>

      <h2>Skader</h2>
      <div class="defect-wrap2">
        <div class="defect-toolbar" style="justify-content:space-between">
          <button type="button" id="clearPins">T√∏m markeringer</button>
        </div>
        <div class="defect-canvas" id="defectCanvas"><!-- bilde/SVG lastes av JS --></div>
      </div>

      <label>Skader (tekst)</label>
      <textarea id="defects" placeholder="Beskriv skader hvis aktuelt"></textarea>

      <h2>Kommentarer</h2>
      <textarea id="comments" placeholder="Tilleggsinformasjon"></textarea>

      <button type="submit" class="primary">Fullf√∏r</button>
      <div class="msg" id="msg"></div>
    </form>
  </div>

<script>
// Funkcija izmƒìra formatƒì≈°anai
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Offline funkcionalitƒÅte darbojas automƒÅtiski fonƒÅ
  const DRIVE_URL = "https://script.google.com/macros/s/AKfycbwiuDPcIHxWA1vtahW6mu_vq1NuQxv2mkbaeWGEmpV1-CEsZK8t6Gq9PYNbd988bv1L/exec";
  const PREVIEW_LOCAL = false;

  // ---- UI / foto ----
  const form = document.getElementById("form");
  const msg = document.getElementById("msg");
  const companyTypeEl = document.getElementById("companyType");
  const businessBlock = document.getElementById("businessBlock");
  const companySelect = document.getElementById("companySelect");
  const otherCompanyBlock = document.getElementById("otherCompanyBlock");
  const otherCompany = document.getElementById("otherCompany");
  const dateInput = document.getElementById("date");
  const brandEl = document.getElementById("brand");
  const vinEl = document.getElementById("vin");
  const mileageEl = document.getElementById("mileage");
  const modelEl = document.getElementById("model");
  const photosEl = document.getElementById("photos");
  const thumbsEl = document.getElementById("thumbs");

  if (!dateInput.value) { dateInput.value = new Date().toISOString().slice(0,10); }

  function refreshCompanyUI() {
    const isBusiness = (companyTypeEl.value === 'business');
    const isOther    = isBusiness && (companySelect.value === 'other');
    businessBlock.classList.toggle('hidden', !isBusiness);
    otherCompanyBlock.classList.toggle('hidden', !isOther);
    companySelect.required = isBusiness;
    otherCompany.required  = isOther;
    if (!isBusiness) { companySelect.value = ''; otherCompany.value = ''; }
  }

  companySelect.addEventListener('invalid', e => e.target.setCustomValidity('Velg bedrift'));
  companySelect.addEventListener('input',  e => e.target.setCustomValidity(''));
  otherCompany.addEventListener('invalid', e => e.target.setCustomValidity('Skriv inn bedriftsnavn'));
  otherCompany.addEventListener('input',  e => e.target.setCustomValidity(''));

  companyTypeEl.addEventListener('change', refreshCompanyUI);
  companySelect.addEventListener('change', refreshCompanyUI);
  refreshCompanyUI();

let photoData = [];              
let fileAgg; let canAgg = false;
try { fileAgg = new DataTransfer(); canAgg = true; } catch(_) {}

function updatePhotoCount(){
  const c = document.getElementById('photoCount');
  if (c) c.textContent = photoData.length ? `(${photoData.length})` : '';
  if (!canAgg) photosEl.setCustomValidity(photoData.length ? '' : 'Legg til minst ett bilde');
}

function isHeic(file){
  return /hei(c|f)/i.test(file.type) || /\.hei(c|f)$/i.test(file.name);
}
function blobToDataURL(blob){
  return new Promise((res, rej)=>{
    const fr = new FileReader(); fr.onload = () => res(fr.result);
    fr.onerror = rej; fr.readAsDataURL(blob);
  });
}
async function fileToJpegDataUrl(file){
  // MaksimƒÅlais attƒìla izmƒìrs (800px platums vai augstums)
  const MAX_IMAGE_SIZE = 800;
  // SƒÅkotnƒìjƒÅ kvalitƒÅte
  const INITIAL_QUALITY = 0.7;
  
  try {
    let imageData;
    
    // HEIC failu konvertƒì≈°ana
    if (isHeic(file) && window.heic2any){
      try {
        const out = await heic2any({ 
          blob: file, 
          toType: 'image/jpeg', 
          quality: INITIAL_QUALITY 
        });
        imageData = await blobToDataURL(out);
      } catch(e){ 
        console.warn('HEIC konvertƒì≈°anas kƒº≈´da:', e);
        imageData = await readFileAsDataURL(file);
      }
    } else {
      imageData = await readFileAsDataURL(file);
    }

    // Ieg≈´stam attƒìla izmƒìrus
    const dimensions = await new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve({ width: img.width, height: img.height });
      img.src = imageData;
    });

    // Aprƒìƒ∑inam nepiecie≈°amo samazinƒÅ≈°anas pakƒÅpi
    const scale = Math.min(1, MAX_IMAGE_SIZE / Math.max(dimensions.width, dimensions.height));
    const targetWidth = Math.round(dimensions.width * scale);
    const targetHeight = Math.round(dimensions.height * scale);

    // SamazinƒÅm attƒìlu
    const canvas = document.createElement('canvas');
    canvas.width = targetWidth;
    canvas.height = targetHeight;
    
    const ctx = canvas.getContext('2d');
    const img = await new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(img);
      img.src = imageData;
    });
    
    // Zƒ´mƒìjam attƒìlu ar labƒÅku kvalitƒÅti
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

    // Mƒìƒ£inƒÅm da≈æƒÅdas kvalitƒÅtes, lƒ´dz ieg≈´stam pietiekami mazu failu
    let quality = INITIAL_QUALITY;
    let result = canvas.toDataURL('image/jpeg', quality);
    
    // Ja fails joprojƒÅm ir par lielu (virs 500KB), mƒìƒ£inƒÅm samazinƒÅt kvalitƒÅti
    while (result.length > 500 * 1024 && quality > 0.3) {
      quality -= 0.1;
      result = canvas.toDataURL('image/jpeg', quality);
    }

    console.log(`Attƒìls apstrƒÅdƒÅts: ${targetWidth}x${targetHeight}, kvalitƒÅte: ${quality.toFixed(2)}, izmƒìrs: ${(result.length/1024).toFixed(1)}KB`);
    
    return result;
  } catch (error) {
    console.error('Kƒº≈´da apstrƒÅdƒÅjot attƒìlu:', error);
    throw new Error('NeizdevƒÅs apstrƒÅdƒÅt attƒìlu. L≈´dzu, izmƒìƒ£iniet citu attƒìlu.');
  }
}

function addThumb(item){
  const wrap = document.createElement('div'); wrap.className = 'thumb';
  const img  = document.createElement('img'); img.src = item.dataUrl; img.alt = item.name||'Bilde';
  const del  = document.createElement('button'); del.type='button'; del.className='thumb-del'; del.title='Slett'; del.textContent='√ó';

  del.addEventListener('click', () => {
    const idx = photoData.indexOf(item);
    if (idx > -1) photoData.splice(idx,1);

    if (canAgg) {
      fileAgg = new DataTransfer();
      for (const p of photoData) if (p._file) fileAgg.items.add(p._file);
      try { photosEl.files = fileAgg.files; } catch(_) {}
    }
    wrap.remove();
    updatePhotoCount();
  });

  wrap.appendChild(img);
  wrap.appendChild(del);
  thumbsEl.appendChild(wrap);
}

photosEl.addEventListener('change', async (e) => {
  const MAX_TOTAL_PHOTOS = 20; // MaksimƒÅlais attƒìlu skaits
  const files = Array.from(e.target.files || []);
  
  // PƒÅrbaudam kopƒìjo attƒìlu skaitu
  if (photoData.length + files.length > MAX_TOTAL_PHOTOS) {
    msg.textContent = `Nevar pievienot vairƒÅk par ${MAX_TOTAL_PHOTOS} attƒìliem`;
    return;
  }

  msg.textContent = "ApstrƒÅdƒÅju attƒìlus...";
  let successCount = 0;
  
  try {
    for (const f of files) {
      try {
        // PƒÅrbaudam faila izmƒìru
        if (f.size > 15 * 1024 * 1024) { // 15MB limits oriƒ£inƒÅlajam failam
          console.warn(`Fails ${f.name} ir par lielu (${(f.size/1024/1024).toFixed(1)}MB)`);
          continue;
        }

        if (canAgg) fileAgg.items.add(f);
        const jpeg = await fileToJpegDataUrl(f);
        const item = { name: f.name, type: 'image/jpeg', dataUrl: jpeg, _file: f };
        photoData.push(item);
        addThumb(item);
        successCount++;
      } catch (err) {
        console.error(`Kƒº≈´da apstrƒÅdƒÅjot failu ${f.name}:`, err);
      }
    }

    if (canAgg) {
      try { photosEl.files = fileAgg.files; } catch(_) {}
    }
    
    updatePhotoCount();
    
    // Pazi≈Üojums par rezultƒÅtu
    if (successCount === 0) {
      msg.textContent = "NeizdevƒÅs pievienot attƒìlus. PƒÅrbaudiet vai tie nav par lielu.";
    } else if (successCount < files.length) {
      msg.textContent = `Pievienoti ${successCount} no ${files.length} attƒìliem. Da≈æi attƒìli bija par lielu.`;
    } else {
      msg.textContent = "";
    }
  } catch (err) {
    console.error('Kƒº≈´da pievienojot attƒìlus:', err);
    msg.textContent = "Kƒº≈´da pievienojot attƒìlus. Mƒìƒ£iniet vƒìlreiz ar mazƒÅkiem attƒìliem.";
  }
});

function readFileAsDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
async function downscaleImage(dataUrl, maxSize, initialQuality = 0.9) {
  const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB maksimƒÅlais izmƒìrs
  let quality = initialQuality;
  let attempt = 0;
  const maxAttempts = 5;

  while (attempt < maxAttempts) {
    try {
      const img = await new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Attƒìla ielƒÅde neizdevƒÅs'));
        img.src = dataUrl;
      });

      // Aprƒìƒ∑inƒÅm izmƒìrus
      let ratio = Math.max(img.width, img.height) / maxSize;
      let w = ratio > 1 ? Math.round(img.width / ratio) : img.width;
      let h = ratio > 1 ? Math.round(img.height / ratio) : img.height;

      // Ja attƒìls ir ƒºoti liels, samazinƒÅm vƒìl vairƒÅk
      if (w * h > 4000000) { // 4 megapikseƒºi
        ratio = Math.sqrt((w * h) / 4000000);
        w = Math.round(w / ratio);
        h = Math.round(h / ratio);
      }

      const canvas = document.createElement('canvas');
      canvas.width = w;
      canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      
      const resultDataUrl = canvas.toDataURL('image/jpeg', quality);
      
      // PƒÅrbaudam izmƒìru
      const size = Math.ceil(resultDataUrl.length * 0.75); // aptuvens base64 izmƒìrs baitos
      
      if (size <= MAX_FILE_SIZE) {
        return resultDataUrl;
      }
      
      // Ja fails joprojƒÅm ir par lielu, samazinƒÅm kvalitƒÅti
      quality *= 0.8;
      attempt++;
      
      console.log(`Attƒìls joprojƒÅm par lielu (${(size/1024/1024).toFixed(2)}MB), mƒìƒ£inu ar kvalitƒÅti ${quality}`);
    } catch (e) {
      console.error('Kƒº≈´da apstrƒÅdƒÅjot attƒìlu:', e);
      throw e;
    }
  }
  
  throw new Error('NeizdevƒÅs pietiekami samazinƒÅt attƒìlu. L≈´dzu, izvƒìlieties mazƒÅku attƒìlu.');
}

function resetPhotos(){
  photoData = [];
  thumbsEl.innerHTML = '';
  try { fileAgg = new DataTransfer(); photosEl.files = fileAgg.files; } catch(_) {}
  updatePhotoCount();
}

  // Defektu shƒìma
  const defectCanvasEl = document.getElementById('defectCanvas');
  const clearPinsBtn = document.getElementById('clearPins');
  let activeType = 'scratch';
  let pins = [];

  clearPinsBtn.addEventListener('click', () => { pins = []; renderPins(); });

  function loadPlan(){
    defectCanvasEl.innerHTML = getPlanSvg();
    renderPins();
  }
  loadPlan();

  defectCanvasEl.addEventListener('click', (e) => {
    if (e.target.classList.contains('pin')) return;
    const r = defectCanvasEl.getBoundingClientRect();
    const xRel = (e.clientX - r.left) / r.width;
    const yRel = (e.clientY - r.top) / r.height;
    const label = prompt("Skademerknad (valgfritt):", "");
    pins.push({ xRel, yRel, label: label||"", type: activeType });
    renderPins();
  });

  function renderPins(){
    defectCanvasEl.querySelectorAll('.pin').forEach(n => n.remove());
    for (const p of pins) {
      const pin = document.createElement('div');
      pin.className = 'pin';
      pin.dataset.type = p.type;
      pin.dataset.label = p.label;
      pin.style.left = (p.xRel*100)+'%';
      pin.style.top  = (p.yRel*100)+'%';
      pin.title = (p.label ? p.label + " ‚Ä¢ " : "") + "Dra for √• flytte, dobbeltklikk for √• slette";

      pin.addEventListener('pointerdown', (ev) => {
        ev.preventDefault();
        const start = defectCanvasEl.getBoundingClientRect();
        const sx = ev.clientX, sy = ev.clientY;
        const ox = p.xRel, oy = p.yRel;
        function move(ev2){
          p.xRel = Math.min(0.995, Math.max(0.005, ox + (ev2.clientX - sx)/start.width));
          p.yRel = Math.min(0.995, Math.max(0.005, oy + (ev2.clientY - sy)/start.height));
          pin.style.left = (p.xRel*100)+'%';
          pin.style.top  = (p.yRel*100)+'%';
        }
        function up(){ window.removeEventListener('pointermove',move); window.removeEventListener('pointerup',up); }
        window.addEventListener('pointermove', move);
        window.addEventListener('pointerup', up);
      });

      pin.addEventListener('dblclick', () => {
        const idx = pins.indexOf(p);
        if (idx > -1) { pins.splice(idx,1); renderPins(); }
      });

      defectCanvasEl.appendChild(pin);
    }
  }

  function getPlanSvg(){
    return `<img src="icons/plan.png" alt="Bilskisse (topp)" class="plan-img">`;
  }

  // Datu sagatavo≈°ana
  function buildEntry(){
    const companyType = companyTypeEl.value;
    let companyCode = "private";
    let companyName = "Privat";
    if (companyType === "business") {
      companyCode = companySelect.value || "other";
      companyName = companySelect.value === "other" ? (otherCompany.value || "").trim() : (companySelect.options[companySelect.selectedIndex]?.text || "").trim();
      if (!companyName) throw new Error("Velg bedrift eller skriv inn navn.");
    }
    const works = Array.from(document.querySelectorAll(".work:checked")).map(cb => cb.value);
    return {
      date: dateInput.value,
      companyType, companyCode, companyName,
      car: { condition: document.getElementById("carCondition").value, brand: brandEl.value.trim(), model: modelEl.value.trim(), vinOrReg: vinEl.value.trim(), mileage: mileageEl.value || "" },
      works,
      workNotes: document.getElementById("workNotes").value.trim(),
      defectsText: document.getElementById("defects").value.trim(),
      comments: document.getElementById("comments").value.trim(),
      photos: photoData
    };
  }

  const WORK_NAMES = {
    innvendig_vask: "Innvendig vask",
    utvendig_vask_voks: "Utvendig vask + voks",
    innvendig_utvendig_vask_voks: "Innvendig/utvendig vask + voks",
    polering1_voks: "1-stegs polering + voks",
    polering2_voks: "2-stegs polering + voks",
    keramisk_coating: "Keramisk coating",
    fullshine_pakke: "Fullshine pakke",
    express_utvendig_vask: "Express utvendig vask",
    express_innvendig_vask: "Express innvendig vask"
  };

  // PDF ƒ£enerƒì≈°ana
  async function makePdfDataUrlFromForm(entry) {
  // 1) Defektu shƒìma ‚Üí PNG (no redzamƒÅ canvasa)
  let defectImgData = '';
  try {
    const defEl = document.getElementById('defectCanvas');
    const defCanvas = await html2canvas(defEl, {
      scale: 2, useCORS: true, backgroundColor: '#ffffff',
      windowWidth: defEl.clientWidth, windowHeight: defEl.clientHeight,
      scrollX: 0, scrollY: 0
    });
    defectImgData = defCanvas.toDataURL('image/png');
  } catch {}

  // 2) Uzb≈´vƒìjam drukas saturu
  const wrap = document.createElement('div');
  wrap.className = 'print-wrap';
  wrap.innerHTML = `
    <div class="pw-header">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="icons/icon-192.png" alt="Ikon" width="62" height="62" style="border-radius:6px" />
        <div class="pw-title">JP-Bilpleie</div>
      </div>
      <div class="pw-doc"><b>Dato:</b> ${entry.date||''}</div>
    </div>

    <div class="sec-title">Kunde</div>
    <table class="kv">
      <tr><th>Type</th><td>${entry.companyType==='business'?'Juridisk person (bedrift)':'Privat'}</td></tr>
      <tr><th>Bedrift</th><td>${entry.companyType==='business' ? (entry.companyName||'') : '‚Äî'}</td></tr>
    </table>

    <div class="sec-title">Kj√∏ret√∏y</div>
    <table class="kv">
      <tr><th>Tilstand</th><td>${entry.car.condition==='new'?'Ny':'Brukt'}</td></tr>
      <tr><th>Merke / Modell</th><td>${(entry.car.brand||'')+' '+(entry.car.model||'')}</td></tr>
      <tr><th>VIN / Reg.nr.</th><td>${entry.car.vinOrReg||''}</td></tr>
      <tr><th>Kilometerstand (km)</th><td>${entry.car.mileage||''}</td></tr>
    </table>

    <div class="sec-title">Utf√∏rt arbeid</div>
    <table class="work-table">
      <thead><tr><th>Arbeid</th><th>Status</th></tr></thead>
      <tbody id="worksTbody"></tbody>
    </table>
    <div style="margin-top:6px;font-size:12px">
      <b>Oppsummering:</b> <span id="worksSummary">‚Äî</span>
    </div>
    <div style="height:6px"></div>
    <div class="text-box">${(entry.workNotes||'').replace(/</g,'&lt;')}</div>

    <div class="sec-title">Skader</div>
    ${defectImgData ? `<img src="${defectImgData}" style="width:50%;border:1px solid #e5e7eb;border-radius:8px">` : '<div class="text-box">‚Äî</div>'}
    <div style="height:6px"></div>
    <div class="text-box">${(entry.defectsText||'').replace(/</g,'&lt;')}</div>

    <div class="sec-title">Kommentarer</div>
    <div class="text-box">${(entry.comments||'').replace(/</g,'&lt;')}</div>

    <div class="sec-title">Bilder</div>
    <div class="photos-block" id="photosBlock"></div>
  `;

  // Tabula ar ‚úì/‚Äî statusu
  const tbody = wrap.querySelector('#worksTbody');
  const selected = new Set(entry.works || []);
  Object.entries(WORK_NAMES).forEach(([code, name]) => {
    const tr = document.createElement('tr');
    const done = selected.has(code);
    tr.innerHTML = `
      <td>${name}</td>
      <td>${done ? '<span class="badge-yes">‚úì Utf√∏rt</span>' : '<span class="badge-no">‚Äî Ikke</span>'}</td>`;
    tbody.appendChild(tr);
  });
  const picked = (entry.works || []).map(w => WORK_NAMES[w] || w);
  wrap.querySelector('#worksSummary').textContent = picked.length ? picked.join(', ') : '‚Äî';

  // Foto
  const pb = wrap.querySelector('#photosBlock');
  (entry.photos||[]).forEach((p, i) => {
    const item = document.createElement('div');
    item.className = 'photo-item';
    item.innerHTML = `<img src="${p.dataUrl}" alt="Foto ${i+1}"><div class="photo-cap">Foto ${i+1}</div>`;
    pb.appendChild(item);
  });

  // 3) NeredzamƒÅ vietƒÅ, pƒìc tam renderƒìjam ar fiksƒìtu ‚Äúlogu‚Äù izmƒìru (vienƒÅdi telefonƒÅ un PC)
  const holder = document.createElement('div');
  holder.style.position = 'fixed'; holder.style.left = '-10000px'; holder.style.top = '0';
  holder.appendChild(wrap);
  document.body.appendChild(holder);

  const canvas = await html2canvas(wrap, {
    scale: 2, useCORS: true, backgroundColor: '#ffffff',
    windowWidth: 794, windowHeight: wrap.scrollHeight, scrollX: 0, scrollY: 0
  });

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const pageWidth  = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const imgData   = canvas.toDataURL('image/jpeg', 0.95);
  const imgWidth  = pageWidth;
  const imgHeight = canvas.height * imgWidth / canvas.width;

  let heightLeft = imgHeight, position = 0;
  pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
  heightLeft -= pageHeight;
  while (heightLeft > 0) {
    pdf.addPage();
    position = heightLeft - imgHeight;
    pdf.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
  }

  holder.remove();
  return pdf.output('datauristring');
}

  // S≈´tƒ´t uz Drive
  async function sendPdfDataUriToDrive(entry, dataUri){
  if (!DRIVE_URL) throw new Error('Har ikke DRIVE_URL');

  const brandLabel = [entry.car.brand, entry.car.model].filter(Boolean).join('_') || 'uten_merke';
  const fileName = `contract_${brandLabel}_${entry.date||''}.pdf`.replace(/\s+/g,'_');
  const base64 = (dataUri.split('base64,')[1] || '');

  const resp = await fetch(DRIVE_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      fileName,
      pdfBase64: base64,
      companyCode: entry.companyCode,
      companyName: entry.companyName,
      date: entry.date,
      brand: entry.car.brand || "",
      model: entry.car.model || ""
    })
  });

  if (!resp.ok) throw new Error(`Upload failed ${resp.status}`);
  return { ok:true };
}

async function idbPut(item) {
  const db = await idbOpen();
  const tx = db.transaction(STORE, 'readwrite');
  const store = tx.objectStore(STORE);
  return new Promise((resolve, reject) => {
    const req = store.put(item);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
    tx.oncomplete = () => db.close();
  });
}

  // Center popup helpers
  function showCenterSuccess(text='Sendt!', sub=''){
    const bg = document.getElementById('successCenter');
    const pop = bg.querySelector('.success-pop');
    document.getElementById('successTitle').textContent = text;
    document.getElementById('successSub').textContent = sub || '';
    bg.classList.add('show');
    requestAnimationFrame(()=>pop.classList.add('show'));
  }
  function hideCenterSuccess(){
    const bg = document.getElementById('successCenter');
    const pop = bg.querySelector('.success-pop');
    pop.classList.remove('show');
    setTimeout(()=>bg.classList.remove('show'), 180);
  }
// Simple IndexedDB Storage
const DB_NAME = 'jpbilpleie';
const STORE = 'outbox';

async function idbOpen() {
  const req = indexedDB.open(DB_NAME, 1);
  req.onupgradeneeded = () => {
    const db = req.result;
    if (!db.objectStoreNames.contains(STORE)) {
      db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
    }
  };
  return new Promise((resolve, reject) => {
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function idbAdd(item) {
  const db = await idbOpen();
  const tx = db.transaction(STORE, 'readwrite');
  const store = tx.objectStore(STORE);
  
  return new Promise((resolve, reject) => {
    const req = store.add({
      ...item,
      addedAt: Date.now()
    });
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
    tx.oncomplete = () => db.close();
  });
}

async function idbAll() {
  const db = await idbOpen();
  const tx = db.transaction(STORE, 'readonly');
  const store = tx.objectStore(STORE);
  
  return new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
    tx.oncomplete = () => db.close();
  });
}

async function idbDel(id) {
  const db = await idbOpen();
  const tx = db.transaction(STORE, 'readwrite');
  const store = tx.objectStore(STORE);
  
  return new Promise((resolve, reject) => {
    const req = store.delete(id);
    req.onsuccess = () => resolve();
    req.onerror = () => reject(req.error);
    tx.oncomplete = () => db.close();
  });
}


// Simple upload with single retry
async function uploadOne(entry, dataUri) {
  try {
    await sendPdfDataUriToDrive(entry, dataUri);
    return true;
  } catch (e) {
    console.warn('Failed to upload:', e);
    try {
      await new Promise(resolve => setTimeout(resolve, 1000));
      await sendPdfDataUriToDrive(entry, dataUri);
      return true;
    } catch (e2) {
      console.warn('Upload retry failed:', e2);
      return false;
    }
  }
}

// Prevent concurrent uploads
let isUploading = false;

// Simple queue processing with loc
async function flushQueue() {
  if (isUploading) {
    console.log('Upload already in progress, skipping...');
    return { sent: 0, left: 0 };
  }

  try {
    isUploading = true;
    const items = await idbAll();
    if (!items.length) return { sent: 0, left: 0 };

    console.log(`Starting upload of ${items.length} items`);
    let sent = 0;

    // Process each item with a small delay between attempts
    for (const item of items) {
      try {
        const attempts = (item.uploadAttempts || 0) + 1;
        item.uploadAttempts = attempts;
        await idbPut(item); // persist attempt count so the cap sticks across runs

        // Skip if already tried too many times
        if (attempts > 3) {
          console.warn(`Skipping item ${item.id} - too many attempts`);
          continue;
        }

        // Add a small delay between uploads
        if (sent > 0) await new Promise(resolve => setTimeout(resolve, 1000));

        const ok = await uploadOne(item.entry, item.dataUri);
        if (ok) {
          await idbDel(item.id);
          sent++;
          console.log(`Successfully uploaded item ${item.id}`);
        }
      } catch (e) {
        console.error(`Failed to process item ${item.id}:`, e);
      }
    }

    const left = (await idbAll()).length;
    console.log(`Upload complete. Sent: ${sent}, Left: ${left}`);
    return { sent, left };
  } finally {
    isUploading = false;
  }
}

// Simple queue or send
async function queueOrSend(entry, dataUri) {
  // Check storage quota
  try {
    if ('storage' in navigator && 'estimate' in navigator.storage) {
      const estimate = await navigator.storage.estimate();
      const available = estimate.quota - estimate.usage;
      if (available < dataUri.length * 1.2) {
        throw new Error('Ikke nok lagringsplass p√• enheten');
      }
    }
  } catch (e) {
    console.warn('Failed to check storage:', e);
  }

  // Try to send immediately if online
  if (navigator.onLine){
    const ok = await uploadOne(entry, dataUri);
    if (ok) return { mode: 'sent' };
  }

  // Otherwise queue for later
  try {
    // Clean up old items (over 7 days)
    const items = await idbAll();
const now = Date.now();
let pending = 0;
for (const item of items) {
  if (item.addedAt && now - item.addedAt > 7 * 24 * 60 * 60 * 1000) {
    await idbDel(item.id);
  } else {
    pending++;
  }
}
if (pending >= 30) {
  throw new Error('Maksimalt antall filer i k√∏ n√•dd (30). Vennligst vent til du er online.');
}
    // Add to queue
    await idbAdd({ entry, dataUri });
    return { mode: 'queued' };
  } catch (e) {
    console.error('Failed to queue:', e);
    throw new Error('Kunne ikke lagre filen offline. Vennligst pr√∏v igjen n√•r du er online.');
  }
}

// Throttle flush attempts
let lastFlushAttempt = 0;
const FLUSH_COOLDOWN = 5000; // 5 seconds between flush attempts

function throttledFlush() {
  const now = Date.now();
  if (now - lastFlushAttempt < FLUSH_COOLDOWN) {
    console.log('Flush attempted too soon, skipping...');
    return;
  }
  lastFlushAttempt = now;
  flushQueue();
}

// Auto flush on page load & when back online, but with throttling
window.addEventListener('online', throttledFlush);
window.addEventListener('load', throttledFlush);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && navigator.onLine) {
    throttledFlush();
  }
});

// Submit
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  refreshCompanyUI();
  if (!form.checkValidity()) { form.reportValidity(); return; }

  try {
    msg.textContent = "Samler data‚Ä¶";
    const entry = buildEntry();
    const dataUri = await makePdfDataUrlFromForm(entry);

    // Always ‚Äúsend‚Äù: upload if possible, else queue for later
    const result = await queueOrSend(entry, dataUri);

    msg.textContent = "";

    if (result.mode === 'sent') {
      showCenterSuccess('Sendt!');
    } else {
      showCenterSuccess('Lagret offline', 'Blir sendt automatisk n√•r du er p√• nett');
    }

    // reset etter OK
    const okBtn = document.getElementById('okSuccess');
    okBtn.onclick = () => {
      hideCenterSuccess();
      form.reset(); pins = []; renderPins(); thumbsEl.innerHTML = "";
      dateInput.value = new Date().toISOString().slice(0,10);
      refreshCompanyUI();
      if (navigator.onLine) throttledFlush();
    };
  } catch (err) {
    console.error(err);
    msg.textContent = err.message || "Feil ved sending";
  }
});
</script>

<!-- Centered success popup (pa vidu ekrƒÅnam) -->
<div id="successCenter" class="success-backdrop" aria-hidden="true">
  <div class="success-pop" role="alertdialog" aria-live="assertive" aria-label="Sendt">
    <div class="icon">‚úì</div>
    <h3 id="successTitle">Sendt!</h3>
    <p id="successSub"></p>
    <button type="button" class="btn" id="okSuccess">OK</button>
  </div>
</div>
  <script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js', { scope: './' })
      .catch(console.error);
  });
}
</script>
</body>
</html>
